<apex:page standardController="Community_News__c" extensions="CommunityNewsController" action="{!initFromEdit}" showHeader="false" sideBar="false" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false">
<apex:composition template="{!$Site.Template}">
<apex:define name="title">{!$Label.LBL_Page_Title}</apex:define>
<apex:define name="body">
	<!-- style>
		.imageselector.selected{
			border: dashed 1px red;
		}
	</style-->
	<div class="row">
		<apex:form id="cnsp1" style="display:none;" styleClass="col-sm-12">
			<apex:pageBlock >
				<apex:pageMessages id="pageMessages"/>
				<apex:pageBlockButtons >
					<apex:commandButton action="{!Submit}" value="{!$Label.BTN_Submit}" styleClass="btn-u"/>
					&nbsp;
					<apex:outputLink value="{!IF(ISBLANK($CurrentPage.parameters.retURL),$Page.CommunityNews,$CurrentPage.parameters.retURL)}" styleClass="btn-u">{!$Label.BTN_Cancel}</apex:outputLink>
					<!--apex:commandButton action="{!Cancel}" value="{!$Label.BTN_Cancel}"/-->
				</apex:pageBlockButtons>
				<apex:pageBlockSection id="cnpbs1" columns="1" collapsible="false">
					<apex:repeat value="{!fieldset}" var="fs">
						<apex:inputField value="{!news[fs.fieldPath]}" required="{!OR(fs.required, fs.dbrequired)}"/>
					</apex:repeat>
					<apex:pageBlockSectionItem >
						<apex:outputLabel value="{!$Label.LBL_Select_Image}"/>
						<apex:outputPanel layout="none">
							<select id="imsel1" onchange="checkimg();">
								<option value="">{!$Label.BTN_Select}</option>
								<option value="f">{!$Label.BTN_ChooseFile}</option>
								<option value="e">{!$Label.LBL_Choose_from_Library}</option>
							</select><br/>
							<apex:inputFile id="cnif1f" value="{!imgBody}" fileName="{!imgFileName}" contentType="{!imgContentType}" style="display:none; margin:5px 0;" onchange="preview(this);"/>
							<apex:outputPanel id="cnif1e" layout="block" onclick="prepareSelect();" styleClass="btn" style="padding:4px 3px; line-height:2.8; display:none;">
								{!$Label.LBL_Choose_from_Library}
							</apex:outputPanel>
							<div id="iidf" style="height:200px; {!IF(ISBLANK(news.Image_Path__c),'display:none;','')}">
								<apex:image id="preview_image" url="{!news.Image_Path__c}" height="200px"/>
							</div>
							<div style="display:none;">
								<apex:inputField value="{!news.Image_Path__c}" id="image_path_field"/>
							</div>
						</apex:outputPanel>
					</apex:pageBlockSectionItem>
					<apex:pageBlockSectionItem >
						<apex:outputLabel value="{!$Label.LBL_Select_Tags}"/>
						<c:CommunityTagSelector oId="{!news.Id}" oType="{!$ObjectType.Community_News_Tag__c.Name}" fName="{!$ObjectType.Community_News_Tag__c.Fields.Community_News__c.Name}"/>
					</apex:pageBlockSectionItem>
				</apex:pageBlockSection>
			</apex:pageBlock> 
		</apex:form>
	</div>
</apex:define>
<apex:define name="scripts">
	<script>
		var $F = jQuery.noConflict();

		$F(document).ready(function() {
			checkprereq();
			$F('[id$=cnpbs1] select option[value=External]').closest('select').on('change',checkprereq);
			$F('#imsel1').find('option:first').attr('disabled','disabled');
			$F('[id$=cnsp1]').show();

		});

		function checkprereq() {
			var dstl = 'table-row';
			if ($F('[id$=cnpbs1] select option[value=External]').closest('select').val() == 'External') {
				dstl = 'none';
			}
			$F('[id$=cnpbs1] textarea[id$=Content__c]').closest('tr').css('display',dstl);
		}
		var $imagesCache = [];
		var $imagePartialUrl = "/servlet/servlet.ImageServer?oid={!$Organization.Id}&id=";
		var $imagePrefix = '{!imgPrefix}';
		function checkimg() {
			var ef = $F('#imsel1').val();
			$F('[id*=cnif1]').hide();
			$F('[id*=cnif1' + ef + ']').show();
		}
		function prepareSelect() {
			if ($imagesCache.length == 0) {
				var docs = new SObjectModel.Document();
				docs.retrieve(
					{
						where: {
							IsPublic: {
								eq: true
							}
						}
					},
					function(err, records, event){
						if(err) {
							alert(err.message);
						}
						else {
							records.forEach(function(record) {
								//console.log(record);
								$imagesCache.push({id:$imagePartialUrl+record.get("Id"), name:record.get("Name")});
							});
							showLibraryImagePopup();
						}
					}
				);
			} else {
				showLibraryImagePopup();
			}
		}
		var $selectedImagePath = null;
		function selectLibraryImage(box) {
			if ($selectedImagePath) {
				var $imgPathField = $F('[id$=image_path_field]');
				$imgPathField.val($selectedImagePath);
				preview(null, $selectedImagePath);
				box.hide();
				$F('.imageselector').removeClass('selected');
			}
		}
		function showLibraryImagePopup() {
			$selectedImagePath = null;
			var $div = $F('<div/>');
			$F.each( $imagesCache, function( key, value ) {
				var $img = $F("<img src='' style='margin:0 5px; width: 80px;'/>");
				$img.attr("src", $imagePrefix + value.id);
				var $wrapperDiv = $F("<div class='imageselector' style='float: left;'/>");
				$wrapperDiv.data("imageNumber", key);
				$wrapperDiv.append($img);
				$div.append($wrapperDiv);
			});
			$div.append($F('<div style="clear:both;"/>'));
			var did = "imagesfromlibrary"+Math.random();//dialog id
			var box = new SimpleDialog(did, true);
			parent.box = box;
			box.setTitle("{!$Label.LBL_Select_Image}<a class='dialogClose' onclick='box.hide()'>Close</a>");
			box.setHeader("");
			box.createDialog();
			box.setWidth(600);
			box.setContentInnerHTML("<div id='libraryimagescontent'/>"/*$div.html()*/);
			box.setupDefaultButtons();
			var $div2 = $F('[id="'+did+'"]');
			$div2.find('.middle .innerContent #libraryimagescontent').append($div);
			$div2.find('.middle .innerContent').append("<div class='innerContent'><div style='float:right;'><button class='btn' onclick='box.hide(); return false;'>{!$Label.BTN_Cancel}</button><button class='btn' onclick='selectLibraryImage(box); return false;'>{!$Label.BTN_Select}</button></div></div>");
			box.show();
		}
		$F(document).on('click', '.imageselector', function() {
			//alert();
			var $img = $imagesCache[$F(this).data('imageNumber')];
			var $imgnameField = $F('label[id$=cnif1e]');
			$imgnameField.html($img.name);
			$F('.imageselector').removeClass('selected');
			$F(this).addClass('selected');
			$selectedImagePath = $img.id;
		});

		function preview(input, url) {
			if (!url && (input.files && input.files[0])) {
				var reader = new FileReader();
				reader.onload = function (e) {
					$F('[id$=preview_image]')
						.attr('src', e.target.result)
						.width(120)
						.height(120);
				};
				reader.readAsDataURL(input.files[0]);
			}
			if (url) {
				$F('[id$=preview_image]')
					.attr('src', url)
					.width(120)
					.height(120);
			};
			$F('#iidf').show();
		}
	</script>
</apex:define>
</apex:composition>
<apex:remoteObjects >
		<apex:remoteObjectModel name="Document" jsShorthand="roDocument" 
			fields="Name,Id, IsPublic">
		</apex:remoteObjectModel>
	</apex:remoteObjects>
</apex:page>