<apex:page controller="CommunityFeed_PeopleController" showHeader="false" sideBar="false" standardStylesheets="false" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false">
	<apex:composition template="{!$Site.Template}">
		<apex:define name="title">{!$Label.LBL_Page_Title}</apex:define>
		<apex:define name="body">
			<div class="profile" ng-app="PeoplesApp" ng-controller="PeoplesController">
				<div class="container content">
					<div class="row">
						<!--LEFT-->
						<div class="col-md-3 md-margin-bottom-40">
							<c:CommunityUserPhoto />
							<c:CommunityFeedNavigation pn="4" />
						</div>
						<!--LEFT-->
						<!--MIDDLE-->
						<div class="col-md-9">
							<div class="profile-body">
								<!--CENTER-->
								<apex:outputPanel styleClass="panel panel-profile" id="centerContent" layout="block">
									<!--QUICK SEARCH -->
									<div class="row margin-bottom-20">
										<div class="col-md-6 ">
											<div class="input-group">
												<input ng-model="quickSearchQuery" class="form-control" placeholder="Type a Name..." value="" id="quickSearchInput" />
												<span class="input-group-btn">
													<button id="quickSearchButton" class="btn-u">
														<i class="fa fa-search"></i>
													</button>
												</span>
											</div>
										</div>
										<div class="col-md-6 ">
										</div>
									</div>
									<!--QUICK SEARCH -->
									<div class="tab-v1">
										<ul class="nav nav-tabs">
											<li class="active" ng-click="page.goToFirst();"><a data-toggle="tab" href="#all_people_tab">All People</a></li>
											<li class="" ng-click="page.goToFirst();"><a href="#people_i_follow_tab" data-toggle="tab">People I Follow</a></li>
										</ul>
										<div class="tab-content">
											<div class="tab-pane active" id="all_people_tab">
												<div class="col-md-12">
													<div class="media media-v2" ng-repeat="p in allPeople | quickSearch:this | startFrom:page.startFrom() | limitTo:page.pageSize">
														<a class="pull-left" href="{!$Page.CommunityProfilePage}?id={{ p.MemberId }}">
															<img class="media-object rounded-x" ng-src="{{ p.MemberPhotoUrl }}" src="/s.gif" alt="" />
														</a>
														<div class="pull-right">
															<button class="btn-u" ng-hide="p.MemberIsFollowing" ng-click="followAction(p);"><i class="fa fa-plus-circle"></i>&nbsp;Follow</button>
															<button class="btn-u btn-u-blue" ng-show="p.MemberIsFollowing" ng-click="unFollowAction(p);"><i class="fa fa-check"></i>&nbsp;Following</button>
														</div>
														<div class="media-body">
															<h4 class="media-heading">
																<strong><a href="{!$Page.CommunityProfilePage}?id={{ p.MemberId }}">{{ p.MemberName }}</a></strong>
																<!--<small>5 hours ago</small>-->
															</h4>
															<p>
																{{ p.MemberContactRole }}
															</p>
														</div>
													</div>
												</div>
												<div class="peoples_nav">
													<table style="width: 100%;">
														<tr>
															<td style="width: 30%;">{{ (page.startFrom()+1) }}-{{ page.nowOnPage() }} of {{ page.totalRecords }}</td>
															<td style="text-align: center;">
																<ul class="pagination">
																	<li ng-class="{disabled:(page.currentPage == 1)}">
																		<span ng-disabled="page.currentPage == 1" ng-click="page.goToFirst();">
																			<i class="fa fa-backward"></i>
																		</span>
																	</li>
																	<li ng-class="{disabled:(page.currentPage == 1)}">
																		<span ng-disabled="page.currentPage == 1" ng-click="page.goToPrev();">
																			<i class="fa fa-caret-left"></i>&nbsp;Previous
																		</span>
																	</li>
																	<li ng-class="{disabled:(page.currentPage >= page.totalPages())}">
																		<span ng-disabled="page.currentPage >= page.totalPages()" ng-click="page.goToNext();">
																			Next&nbsp;<i class="fa fa-caret-right"></i>
																		</span>
																	</li>
																	<li ng-class="{disabled:(page.currentPage >= page.totalPages())}">
																		<span ng-disabled="page.currentPage >= page.totalPages()" ng-click="page.goToLast();">
																			<i class="fa fa-forward"></i>
																		</span>
																	</li>
																</ul>
															</td>
															<td style="width: 30%; text-align: right;">
																Page&nbsp;&nbsp;
																<input type="number" ng-disabled="page.totalPages() == 0" class="form-control" ng-model="page.currentPage" ng-change="page.changePageNumber()" style="width: 50px; padding: 3px; display: inherit;"/>
																&nbsp;&nbsp;of&nbsp;&nbsp;{{ page.totalPages() }}
															</td>
														</tr>
													</table>
												</div>
												<div class="clearfix"></div>
											</div>

											<div class="tab-pane" id="people_i_follow_tab">
												<div class="col-md-12">
													<div class="media media-v2" ng-repeat="p in allPeople | peopleIFollow:this | quickSearch:this | startFrom:page.startFrom() | limitTo:page.pageSize">
														<a class="pull-left" href="{!$Page.CommunityProfilePage}?id={{ p.MemberId }}">
															<img class="media-object rounded-x" ng-src="{{ p.MemberPhotoUrl }}" src="/s.gif" alt="" />
														</a>
														<div class="pull-right">
															<button class="btn-u" ng-hide="p.MemberIsFollowing" ng-click="followAction(p);"><i class="fa fa-plus-circle"></i>&nbsp;Follow</button>
															<button class="btn-u btn-u-blue" ng-show="p.MemberIsFollowing" ng-click="unFollowAction(p);"><i class="fa fa-check"></i>&nbsp;Following</button>
														</div>
														<div class="media-body">
															<h4 class="media-heading">
																<strong><a href="{!$Page.CommunityProfilePage}?id={{ p.MemberId }}">{{ p.MemberName }}</a></strong>
															</h4>
															<p>
																{{ p.MemberContactRole }}
															</p>
														</div>
													</div>
												</div>
												<div class="peoples_nav">
													<table style="width: 100%;">
														<tr>
															<td style="width: 30%;">{{ (page.startFrom()+1) }}-{{ page.nowOnPage() }} of {{ page.totalRecords }}</td>
															<td style="text-align: center;">
																<ul class="pagination">
																	<li ng-class="{disabled:(page.currentPage == 1)}">
																		<span ng-disabled="page.currentPage == 1" ng-click="page.goToFirst();">
																			<i class="fa fa-backward"></i>
																		</span>
																	</li>
																	<li ng-class="{disabled:(page.currentPage == 1)}">
																		<span ng-disabled="page.currentPage == 1" ng-click="page.goToPrev();">
																			<i class="fa fa-caret-left"></i>&nbsp;Previous
																		</span>
																	</li>
																	<li ng-class="{disabled:(page.currentPage >= page.totalPages())}">
																		<span ng-disabled="page.currentPage >= page.totalPages()" ng-click="page.goToNext();">
																			Next&nbsp;<i class="fa fa-caret-right"></i>
																		</span>
																	</li>
																	<li ng-class="{disabled:(page.currentPage >= page.totalPages())}">
																		<span ng-disabled="page.currentPage >= page.totalPages()" ng-click="page.goToLast();">
																			<i class="fa fa-forward"></i>
																		</span>
																	</li>
																</ul>
															</td>
															<td style="width: 30%; text-align: right;">
																Page&nbsp;&nbsp;
																<input type="number" ng-disabled="page.totalPages() == 0" class="form-control" ng-model="page.currentPage" ng-change="page.changePageNumber()" style="width: 50px; padding: 3px; display: inherit;"/>
																&nbsp;&nbsp;of&nbsp;&nbsp;{{ page.totalPages() }}
															</td>
														</tr>
													</table>
												</div>
												<div class="clearfix"></div>
											</div>
										</div>
									</div>
								</apex:outputPanel>
								<!--CENTER-->
							</div>
						</div>
						<!--MIDDLE-->
					</div>
				</div>
			</div>
		</apex:define>
		<apex:define name="scripts">
			<style type="text/css">
				.peoples_nav .pagination>li>a,
				.peoples_nav .pagination>li>span {
					border: none;
					cursor: pointer;
				}
			</style>
			<script type="text/javascript" src="{!$Resource.CommunityResources}/js/underscore/underscore-min.js" ></script>
			<script type="text/javascript" src="{!$Resource.CommunityResources}/js/angularjs/angular.min.js" ></script>
			<script type="text/javascript">
				var PeoplesApp = angular.module('PeoplesApp', []);
				PeoplesApp.factory('getPeoples', ['$q', '$rootScope', function($q, $rootScope) {
					return function() {
						var deferred = $q.defer();
						if ($rootScope.getDataStatus != 'InProgress') {
							$rootScope.getDataStatus = 'InProgress';
							Visualforce.remoting.Manager.invokeAction(
								'CommunityFeed_PeopleController.getPeoples',
								function(result, event) {
									$rootScope.$apply(function() {
										if (event.status) {
											deferred.resolve(result);
											$rootScope.getDataStatus = 'Finished';
										} else {
											deferred.reject(event);
											$rootScope.getDataStatus = 'Finished';
										}
									})
								},
								{ buffer: true, escape: true, timeout: 30000 }
							);
						} else {
							deferred = null;
							return null;
						}
						return deferred.promise;
					}
				}]);
				PeoplesApp.factory('subscriberAction', ['$q', '$rootScope', function($q, $rootScope) {
					return function(pId, isFollow) {
						var deferred = $q.defer();
						if ($rootScope.getDataStatus != 'InProgress') {
							$rootScope.getDataStatus = 'InProgress';
							Visualforce.remoting.Manager.invokeAction(
								'CommunityFeed_PeopleController.subscriberAction',
								pId,
								isFollow,
								function(result, event) {
									$rootScope.$apply(function() {
										if (event.status) {
											deferred.resolve(result);
											$rootScope.getDataStatus = 'Finished';
										} else {
											deferred.reject(event);
											$rootScope.getDataStatus = 'Finished';
										}
									})
								},
								{ buffer: true, escape: true, timeout: 30000 }
							);
						} else {
							deferred = null;
							return null;
						}
						return deferred.promise;
					}
				}]);
				PeoplesApp.filter('startFrom', function() {
					return function(input, start) {
						start = +start;
						return input.slice(start);
					}
				});
				PeoplesApp.filter('quickSearch', function() {
					return function(input, scope) {
						var searchWords = scope.quickSearchQuery.match(/(\w){2,}/g);
						//scope.debug.searchBy = searchWords;
						if (searchWords) {
							//var re = new RegExp(searchWords.join('|'), "ig");
							var reText = '';
							for (var i = 0; i < searchWords.length; i++) {
								reText += '(?=.*'+searchWords[i]+')';
							}
							var re = new RegExp(reText, "ig");
							var output = [];
							for (var j = 0; j < input.length; j++) {
								if (input[j].MemberName.match(re) != null) {
									output.push(input[j]);
								}
							}
							input = output;
						}
						scope.page.totalRecords = input.length;
						return input;
					}
				});
				PeoplesApp.filter('peopleIFollow', function() {
					return function(input, scope) {
						var output = [];
						for (var j = 0; j < input.length; j++) {
							if (input[j].MemberIsFollowing) {
								output.push(input[j]);
							}
						}
						input = output;
						return input;
					}
				});
				PeoplesApp.controller('PeoplesController', ['$scope', '$filter' ,'getPeoples', 'subscriberAction', function($scope, $filter, getPeoples, subscriberAction) {
					$scope.quickSearchQuery = '';
					$scope.page = {
						pageSize: 25,
						currentPage: 1,
						totalRecords: 1,
						totalPages: function() {
							return Math.ceil($scope.page.totalRecords/$scope.page.pageSize);
						},
						changePageNumber : function () {
							if($scope.page.currentPage < 1) {
								$scope.page.currentPage = 1;
							} else if ($scope.page.currentPage > $scope.page.totalPages()) {
								$scope.page.currentPage = $scope.page.totalPages();
							}
						},
						nowOnPage: function() {
							return ($scope.page.currentPage*$scope.page.pageSize + $scope.page.pageSize < $scope.page.totalRecords)
								? $scope.page.currentPage*$scope.page.pageSize+$scope.page.pageSize 
								: $scope.page.totalRecords;
						},
						goToLast: function() {
							console.log('last');
							$scope.page.currentPage = $scope.page.totalPages(); 
						},
						goToFirst: function() {
							console.log('first');
							$scope.page.currentPage = 1;
						},
						goToPrev: function() {
							console.log('prev');
							if ($scope.page.currentPage > 1) {
								$scope.page.currentPage = $scope.page.currentPage - 1;
							}
						},
						goToNext: function() {
							console.log('next');
							if ($scope.page.currentPage < $scope.page.totalPages()) {
								$scope.page.currentPage = $scope.page.currentPage + 1;
							}
						},
						startFrom: function() {
							return $scope.page.currentPage*$scope.page.pageSize-$scope.page.pageSize;
						}
					};
					$scope.followAction = function(p) {
						p.MemberIsFollowing = true;
						$scope.followUnfollow(p.MemberId, p.MemberIsFollowing);
					}
					$scope.unFollowAction = function(p) {
						p.MemberIsFollowing = false;
						$scope.followUnfollow(p.MemberId, p.MemberIsFollowing);
					}
					$scope.followUnfollow = function(pId, isFollow) {
						var def = subscriberAction(pId, isFollow);
						if (def != null) {
							$scope.inProgress = false;
							def.then(function(result) {
									console.log(result);
									if ($scope.inProgress == true) {
										$scope.followUnfollow();
									}
								},
								function(error){
									console.log(error);
								}
							);
						} else {
							$scope.inProgress = true;
						}
					};
					$scope.updatePeopleScope = function () {
						var def = getPeoples();
						if (def != null) {
							$scope.inProgress = false;
							def.then(function(result) {
									console.log(result);
									$scope.allPeople = result;
									$scope.page.currentPage = 1;
									$scope.page.totalRecords = result.length;
									if ($scope.inProgress == true) {
										$scope.updatePeopleScope();
									}
								},
								function(error){
									console.log(error);
									$scope.page.currentPage = 1;
								}
							);
						} else {
							$scope.inProgress = true;
						}
					};
					$scope.updatePeopleScope();

					$scope.allPeople = [
					];
				}]);
			</script>
		</apex:define>
	</apex:composition>
</apex:page>