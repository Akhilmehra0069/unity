<apex:page standardController="Community_News__c" extensions="CommunityNewsController" action="{!initFromEdit}">
	<script src="{!$Resource.CommunityResources}/js/jquery-1.11.2.min.js"></script>
	<style>
		.imageselector.selected{
			border: dashed 1px red;
		}
	</style>
	<apex:form >
		<span id="cnsp1" style="display:none;">
			<apex:pageBlock >
				<apex:pageMessages id="pageMessages"/>
				<apex:pageBlockButtons >
					<apex:commandButton action="{!Submit}" value="{!$Label.BTN_Submit}"/>
					<apex:commandButton action="{!Cancel}" value="{!$Label.BTN_Cancel}"/>
				</apex:pageBlockButtons>
				<apex:pageBlockSection id="cnpbs1" columns="1" collapsible="false">
					<apex:repeat value="{!fieldset}" var="fs">
						<apex:inputField value="{!news[fs.fieldPath]}" required="{!OR(fs.required, fs.dbrequired)}"/>
					</apex:repeat>
					<apex:pageBlockSectionItem >
						<apex:outputLabel value="{!$Label.LBL_Select_Image}"/>
						<apex:outputPanel layout="none">
							<select id="imsel1" onchange="checkimg();">
								<option value="">{!$Label.BTN_Select}</option>
								<option value="f">{!$Label.BTN_ChooseFile}</option>
								<option value="e">{!$Label.LBL_Choose_from_Library}</option>
							</select><br/>
							<apex:inputFile id="cnif1f" value="{!imgBody}" fileName="{!imgFileName}" contentType="{!imgContentType}" style="display:none;" onchange="preview(this);"/>
							<apex:outputLabel id="cnif1e" value="Library [LBL TBD]" style="display:none;"/>
							<div id="iidf" style="height:200px; {!IF(ISBLANK(news.Image_Path__c),'display:none;','')}">
								<apex:image id="preview_image" url="{!news.Image_Path__c}" height="200px"/>
							</div>
							<div style="display:none;">
								<apex:inputField value="{!news.Image_Path__c}" id="image_path_field"/>
							</div>
						</apex:outputPanel>
					</apex:pageBlockSectionItem>
					<apex:pageBlockSectionItem >
						<apex:outputLabel value="{!$Label.LBL_Select_Tags}"/>
						<c:CommunityTagSelector oId="{!news.Id}" oType="{!$ObjectType.Community_News_Tag__c.Name}" fName="{!$ObjectType.Community_News_Tag__c.Fields.Community_News__c.Name}"/>
					</apex:pageBlockSectionItem>
				</apex:pageBlockSection>
			</apex:pageBlock> 
		</span>
	</apex:form>
	<!-- Remote Objects definition to set accessible sObjects and fields -->
    <apex:remoteObjects >
        <apex:remoteObjectModel name="Document" jsShorthand="roDocument" 
            fields="Name,Id, IsPublic">
        </apex:remoteObjectModel>
    </apex:remoteObjects>
	<script>
		var $F = jQuery.noConflict();

		$F(document).ready(function() {
			checkprereq();
			$F('[id$=cnpbs1] select option[value=External]').closest('select').on('change',checkprereq);
			$F('#imsel1').find('option:first').attr('disabled','disabled');
			$F('#cnsp1').show();

		});

		function checkprereq() {
			var dstl = 'table-row';
			if ($F('[id$=cnpbs1] select option[value=External]').closest('select').val() == 'External') {
				dstl = 'none';
			}
			$F('[id$=cnpbs1] textarea[id$=Content__c]').closest('tr').css('display',dstl);
		}
		var $imagesCache = [];
		var $imagePartialUrl = "/servlet/servlet.ImageServer?oid={!$Organization.Id}&id=";
		function checkimg() {
			var ef = $F('#imsel1').val();
			$F('[id*=cnif1]').hide();
			$F('[id*=cnif1' + ef + ']').show();

			if (ef == "e") {
				if ($imagesCache.length == 0) {
					var docs = new SObjectModel.Document();
					docs.retrieve(
						{
							where: {
								IsPublic: {
									eq: true
								}
							}
						},
						function(err, records, event){
			                if(err) {
			                    alert(err.message);
			                }
			                else {
			                    records.forEach(function(record) {
			                        //console.log(record);
			                        $imagesCache.push({id:$imagePartialUrl+record.get("Id"), name:record.get("Name")});
			                    });
			                    showLibraryImagePopup();
			                }
			            }
			        );
				} else {
					showLibraryImagePopup();
				}
			}
		}
		var $selectedImagePath = null;
		function selectLibraryImage(box) {
			if ($selectedImagePath) {
				var $imgPathField = $F('[id$=image_path_field]');
				$imgPathField.val($selectedImagePath);
				preview(null, $selectedImagePath);
				box.hide();
				$F('.imageselector').removeClass('selected');
			}
		}
		function showLibraryImagePopup() {
			$selectedImagePath = null;
			var $div = $F('<div/>');
			$F.each( $imagesCache, function( key, value ) {
				var $img = $F("<img src='' style='margin:0 5px; width: 80px;'/>");
				$img.attr("src", value.id);
				var $wrapperDiv = $F("<div class='imageselector' style='float: left;'/>");
				$wrapperDiv.data("imageNumber", key);
				$wrapperDiv.append($img);
				$div.append($wrapperDiv);
			});
			$div.append($F('<div style="clear:both;"/>'));
			var did = "imagesfromlibrary"+Math.random();//dialog id
			var box = new SimpleDialog(did, true);
		    parent.box = box;
		    box.setTitle("{!$Label.LBL_Select_Image}<a class='dialogClose' onclick='box.hide()'>Close</a>");
		    box.setHeader("");
		    box.createDialog();
		    box.setWidth(600);
		    box.setContentInnerHTML("<div id='libraryimagescontent'/>"/*$div.html()*/);
		    box.setupDefaultButtons();
		    var $div2 = $F('[id="'+did+'"]');
		    $div2.find('.middle .innerContent #libraryimagescontent').append($div);
		    $div2.find('.middle .innerContent').append("<div class='innerContent'><div style='float:right;'><button class='btn' onclick='box.hide(); return false;'>{!$Label.BTN_Cancel}</button><button class='btn' onclick='selectLibraryImage(box); return false;'>{!$Label.BTN_Select}</button></div></div>");
		    box.show();
		}
		$F(document).on('click', '.imageselector', function() {
			//alert();
			var $img = $imagesCache[$F(this).data('imageNumber')];
			var $imgnameField = $F('label[id$=cnif1e]');
			$imgnameField.html($img.name);
			$F('.imageselector').removeClass('selected');
			$F(this).addClass('selected');
			$selectedImagePath = $img.id;
		});

		function preview(input, url) {
			if (!url && (input.files && input.files[0])) {
				var reader = new FileReader();
				reader.onload = function (e) {
					$('[id$=preview_image]')
						.attr('src', e.target.result)
						.width(120)
						.height(120);
				};
				reader.readAsDataURL(input.files[0]);
			}
			if (url) {
				$('[id$=preview_image]')
					.attr('src', url)
					.width(120)
					.height(120);
			};
			$F('#iidf').show();
		}
	</script>
</apex:page>